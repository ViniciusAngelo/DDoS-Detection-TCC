<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDoS Detection Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --bg: #0e1117;        /* Streamlit-like dark */
            --panel: #161a23;     /* Card background */
            --panel-2: #1b2030;   /* Subtle contrast */
            --text: #e6edf3;      /* Primary text */
            --muted: #9da7b3;     /* Secondary text */
            --border: #222733;    /* Borders */
            --accent: #2b79c2;    /* Accent (minimal use) */
        }

        html, body {
            height: 100%;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Ubuntu', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: transparent;
            border-bottom: 1px solid var(--border);
        }

        .navbar-brand {
            color: var(--text) !important;
            font-weight: 600;
            letter-spacing: .3px;
        }

        .container {
            max-width: 1080px;
        }

        .card {
            background-color: var(--panel);
            border: 1px solid var(--border);
            border-radius: 14px;
            box-shadow: 0 2px 20px rgba(0,0,0,.25);
            margin-bottom: 22px;
        }

        .card-header {
            background: linear-gradient(180deg, var(--panel), var(--panel-2));
            color: var(--text);
            border-bottom: 1px solid var(--border);
            font-weight: 600;
            font-size: 0.95rem;
            padding: 12px 16px;
        }

        .card-body {
            padding: 16px;
        }

        .stats p {
            margin: 0 0 6px 0;
            color: var(--muted);
            font-size: .925rem;
        }
        .stats .stat-value {
            color: var(--text);
            font-weight: 600;
            font-size: 1.05rem;
        }

        /* Controls */
        .simulation-controls .btn,
        .simulation-controls .form-control,
        .simulation-controls .form-select {
            background: #111522;
            color: var(--text);
            border: 1px solid var(--border);
        }
        .simulation-controls .btn:hover {
            background: #0f1420;
        }
        .simulation-controls .btn:disabled {
            opacity: .6;
        }
        .simulation-controls .btn {
            margin-right: 8px;
        }
        .form-control-sm {
            width: 120px;
            display: inline-block;
        }

        /* Chart container */
        #attackTypeChart {
            max-height: 280px;
        }

        .meta-inline {
            color: var(--muted);
            font-size: .9rem;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">DDoS Detection Dashboard</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row g-3">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Estatísticas de detecção</div>
                    <div class="card-body stats">
                        <div class="row g-3 mb-2">
                            <div class="col-6">
                                <div>Total de pacotes</div>
                                <div class="stat-value" id="totalPackets">0</div>
                            </div>
                            <div class="col-6">
                                <div>Ataques detectados</div>
                                <div class="stat-value" id="attacksDetected">0</div>
                            </div>
                            <div class="col-6">
                                <div>Tráfego normal</div>
                                <div class="stat-value" id="normalTraffic">0</div>
                            </div>
                            <div class="col-6">
                                <div>Última detecção</div>
                                <div class="stat-value" id="lastDetection">N/A</div>
                            </div>
                        </div>
                        <canvas id="attackTypeChart"></canvas>
                        <div class="meta-inline mt-2">Cores apenas no gráfico para foco visual.</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">Controles de simulação</div>
                    <div class="card-body simulation-controls">
                        <div class="d-flex align-items-center flex-wrap gap-2">
                            <button id="startSimulationBtn" class="btn btn-sm">Iniciar</button>
                            <input type="number" id="numPackets" class="form-control form-control-sm" value="100" min="1" placeholder="Pacotes">
                            <input type="number" id="delay" class="form-control form-control-sm" value="0.01" step="0.001" min="0" placeholder="Delay (s)">
                            <button id="stopSimulationBtn" class="btn btn-sm" disabled>Parar</button>
                        </div>
                        <div class="meta-inline mt-3">Pacotes: <span id="simPacketsCount">100</span> • Delay (s): <span id="simDelay">0.01</span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin + '/api/ddos';
        let attackTypeChart;

        // Buscar e atualizar estatísticas (mínimo de logs e cores fora do gráfico)
        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/stats`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();

                // Totais
                const attacksDetected = (data.attacks_detected?.SynFlood || 0) +
                                        (data.attacks_detected?.ICMPFlood || 0) +
                                        (data.attacks_detected?.UDPFlood || 0);

                document.getElementById('totalPackets').textContent = data.total_packets ?? 0;
                document.getElementById('attacksDetected').textContent = attacksDetected;
                document.getElementById('normalTraffic').textContent = data.attacks_detected?.Normal ?? 0;
                document.getElementById('lastDetection').textContent = data.last_detection || 'N/A';

                // Gráfico
                updateChart(data.attacks_detected || { SynFlood: 0, ICPMFlood: 0, UDPFlood: 0, Normal: 0 });
            } catch (error) {
                // Silencioso para não poluir a UI
            }
        }

        function updateChart(attacksDetected) {
            const labels = Object.keys(attacksDetected);
            const dataValues = Object.values(attacksDetected);

            if (attackTypeChart) {
                attackTypeChart.data.labels = labels;
                attackTypeChart.data.datasets[0].data = dataValues;
                attackTypeChart.update();
                return;
            }

            const ctx = document.getElementById('attackTypeChart').getContext('2d');
            attackTypeChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: dataValues,
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.8)',  // SynFlood
                            'rgba(54, 162, 235, 0.8)',  // ICMPFlood
                            'rgba(255, 206, 86, 0.8)',  // UDPFlood
                            'rgba(75, 192, 192, 0.8)'   // Normal
                        ],
                        borderColor: 'rgba(0,0,0,0)',
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: '#e6edf3',
                                boxWidth: 14,
                                boxHeight: 14,
                            }
                        },
                        title: {
                            display: true,
                            text: 'Distribuição de ataques',
                            color: '#e6edf3',
                            font: { weight: 500 }
                        },
                        tooltip: {
                            titleColor: '#e6edf3',
                            bodyColor: '#e6edf3',
                            backgroundColor: 'rgba(22, 26, 35, 0.9)',
                            borderColor: '#222733',
                            borderWidth: 1
                        }
                    }
                }
            });
        }

        // Controles de simulação
        document.getElementById('startSimulationBtn').addEventListener('click', async () => {
            const numPackets = document.getElementById('numPackets').value;
            const delay = document.getElementById('delay').value;
            document.getElementById('simPacketsCount').textContent = numPackets;
            document.getElementById('simDelay').textContent = delay;

            document.getElementById('startSimulationBtn').disabled = true;
            document.getElementById('stopSimulationBtn').disabled = false;

            try {
                const response = await fetch(`${API_BASE_URL}/simulate_traffic`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ num_packets: parseInt(numPackets), delay: parseFloat(delay) })
                });
                await response.json();
            } catch (_) {
                document.getElementById('startSimulationBtn').disabled = false;
                document.getElementById('stopSimulationBtn').disabled = true;
            }
        });

        document.getElementById('stopSimulationBtn').addEventListener('click', () => {
            alert('A simulação é executada em lote e não pode ser parada diretamente pelo dashboard. Aguarde a conclusão.');
            document.getElementById('startSimulationBtn').disabled = false;
            document.getElementById('stopSimulationBtn').disabled = true;
        });

        // Atualização periódica
        setInterval(fetchStats, 2000);
        fetchStats();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>