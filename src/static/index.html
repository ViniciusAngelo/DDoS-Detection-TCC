<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DDoS Detection Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #f0f2f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background-color: #4a004a; /* Deep Purple */
        }
        .navbar-brand {
            color: #ffffff !important;
            font-weight: bold;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1 );
            margin-bottom: 20px;
        }
        .card-header {
            background-color: #6a006a; /* Medium Purple */
            color: white;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
            font-weight: bold;
            font-size: 1.1em;
        }
        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background-color: #fdfdff;
            border-radius: 10px;
            padding: 10px;
        }
        .list-group-item {
            border: none;
            border-bottom: 1px solid #eee;
            padding: 8px 0;
            font-size: 0.9em;
        }
        .list-group-item:last-child {
            border-bottom: none;
        }
        .synflood, .icmpflood, .udpflood {
            font-weight: bold;
            color: #dc3545; /* Red for attacks */
        }
        .normal {
            font-weight: bold;
            color: #28a745; /* Green for normal traffic */
        }
        .simulation-controls .btn {
            margin-right: 10px;
        }
        .form-control-sm {
            width: 80px;
            display: inline-block;
        }
        .log-entry.attack {
            border-left: 4px solid #e74c3c;
            background: #fdf2f2;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        .log-entry.normal {
            border-left: 4px solid #27ae60;
            background: #f0f9f0;
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
        }
        .log-entry .timestamp {
            color: #7f8c8d;
            font-weight: bold;
            margin-right: 5px;
        }
        .log-entry .attack-type {
            font-weight: bold;
            text-transform: uppercase;
        }
        .log-entry .confidence {
            color: #f39c12;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">DDoS Detection Dashboard</a>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-bar-chart-fill"></i> Estatísticas de Detecção
                    </div>
                    <div class="card-body">
                        <p>Total de Pacotes Processados: <span id="totalPackets">0</span></p>
                        <p>Ataques Detectados: <span id="attacksDetected">0</span></p>
                        <p>Tráfego Normal: <span id="normalTraffic">0</span></p>
                        <p>Última Detecção: <span id="lastDetection">N/A</span></p>
                        <canvas id="attackTypeChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-clock-history"></i> Log de Detecções Recentes
                    </div>
                    <div class="card-body">
                        <div class="log-container">
                            <ul id="detectionLog" class="list-group list-group-flush">
                                <!-- Logs will be appended here -->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="bi bi-play-circle-fill"></i> Controles de Simulação
                    </div>
                    <div class="card-body simulation-controls">
                        <button id="startSimulationBtn" class="btn btn-success">Iniciar Simulação</button>
                        <input type="number" id="numPackets" class="form-control-sm" value="100" min="1">
                        <input type="number" id="delay" class="form-control-sm" value="0.01" step="0.001" min="0">
                        <button id="stopSimulationBtn" class="btn btn-danger" disabled>Parar Simulação</button>
                        <p class="mt-2">Pacotes: <span id="simPacketsCount">100</span>, Delay (s): <span id="simDelay">0.01</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin + '/api/ddos';
        let attackTypeChart;

        // Função para buscar e atualizar as estatísticas
        async function fetchStats() {
            try {
                const response = await fetch(`${API_BASE_URL}/stats`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('Dados da API:', data); // Para depuração

                // Atualizar estatísticas gerais
                document.getElementById('totalPackets').textContent = data.total_packets;
                document.getElementById('attacksDetected').textContent = data.attacks_detected.SynFlood + data.attacks_detected.ICMPFlood + data.attacks_detected.UDPFlood;
                document.getElementById('normalTraffic').textContent = data.attacks_detected.Normal || 0;
                document.getElementById('lastDetection').textContent = data.last_detection || 'N/A';

                // Atualizar gráfico de tipos de ataque
                updateChart(data.attacks_detected);

                // Atualizar log de detecções
                updateDetectionLog(data.detection_history);

            } catch (error) {
                console.error('Erro ao atualizar estatísticas:', error);
            }
        }

        // Função para atualizar o gráfico
        function updateChart(attacksDetected) {
            const labels = Object.keys(attacksDetected);
            const dataValues = Object.values(attacksDetected);

            if (attackTypeChart) {
                attackTypeChart.data.labels = labels;
                attackTypeChart.data.datasets[0].data = dataValues;
                attackTypeChart.update();
            } else {
                const ctx = document.getElementById('attackTypeChart').getContext('2d');
                attackTypeChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: dataValues,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)', // SynFlood
                                'rgba(54, 162, 235, 0.7)', // ICMPFlood
                                'rgba(255, 206, 86, 0.7)', // UDPFlood
                                'rgba(75, 192, 192, 0.7)'  // Normal
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: true,
                                text: 'Distribuição de Ataques Detectados'
                            }
                        }
                    }
                });
            }
        }

        // Função para atualizar o log de detecções
        function updateDetectionLog(history) {
            const logList = document.getElementById('detectionLog');
            logList.innerHTML = ''; // Limpa o log para recarregar com o histórico completo

            // Inverte a ordem para mostrar os mais recentes primeiro
            history.slice().reverse().forEach(item => {
                const listItem = document.createElement('li');
                
                let typeClass = item.type.toLowerCase();
                // Garante que o confidence seja formatado corretamente
                const confidence = item.confidence ? `(${item.confidence})` : '';

                // Adiciona classes CSS para estilização baseada no tipo
                listItem.className = `list-group-item log-entry ${typeClass}`;

                listItem.innerHTML = `
                    <span class="timestamp">[${item.timestamp}]</span> 
                    <span class="attack-type ${typeClass}">${item.type}</span> 
                    <span class="confidence">${confidence}</span> 
                    ${item.source} &rarr; ${item.destination}
                `;
                logList.prepend(listItem); // Adiciona no início para manter a ordem cronológica inversa
            });
        }

        // Controles de Simulação
        document.getElementById('startSimulationBtn').addEventListener('click', async () => {
            const numPackets = document.getElementById('numPackets').value;
            const delay = document.getElementById('delay').value;
            document.getElementById('simPacketsCount').textContent = numPackets;
            document.getElementById('simDelay').textContent = delay;

            document.getElementById('startSimulationBtn').disabled = true;
            document.getElementById('stopSimulationBtn').disabled = false;

            try {
                const response = await fetch(`${API_BASE_URL}/simulate_traffic`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ num_packets: parseInt(numPackets), delay: parseFloat(delay) })
                });
                const result = await response.json();
                console.log('Simulação iniciada:', result);
            } catch (error) {
                console.error('Erro ao iniciar simulação:', error);
                document.getElementById('startSimulationBtn').disabled = false;
                document.getElementById('stopSimulationBtn').disabled = true;
            }
        });

        document.getElementById('stopSimulationBtn').addEventListener('click', () => {
            // A API não tem um endpoint para parar a simulação, pois ela é síncrona
            // Esta funcionalidade seria mais complexa com threads na API
            alert('A simulação é executada em lote e não pode ser parada diretamente via dashboard após iniciada. Aguarde a conclusão.');
            document.getElementById('startSimulationBtn').disabled = false;
            document.getElementById('stopSimulationBtn').disabled = true;
        });

        // Iniciar a busca de estatísticas a cada 2 segundos
        setInterval(fetchStats, 2000);

        // Chamar fetchStats uma vez ao carregar a página para exibir o estado inicial
        fetchStats();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
